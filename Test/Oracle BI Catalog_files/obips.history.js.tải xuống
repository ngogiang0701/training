if(!obips.history){obips.history=function(){};obips.history.create=function(a){saw.storage.HistoryStorage.create();new obips.history.Manager(a)};obips.history.Config=function(a,b,c){this.stateStorage=a||obips.history.Config.StateStorage.HISTORY_STORAGE;this.hashGenerator=b;this.hashParser=c};obips.history.Config.StateStorage=function(){};obips.history.Config.StateStorage.HISTORY_STORAGE="historyStorage";obips.history.Config.StateStorage.LOCATION_BAR="locationBar";obips.history.initialize=function(a,b){obips.history.Manager.getInstance().initialize(a,b)};obips.history.addListener=function(a){return obips.history.Manager.getInstance().addStateChangeListener(a)};obips.history.add=function(c,b,a){obips.history.Manager.getInstance().addToHistory(c,b,a)};obips.history.getHash=function(){var a=window.location.hash;if(a.charAt(0)=="#"){a=a.substring(1)}return saw.userAgent.is_nav?a:saw.decodeURIComponent(a)};obips.history.getCurrentState=function(){return obips.history.Manager.getInstance()._getStateFromHash(obips.history.getHash())};obips.history.setCurrentState=function(a){return obips.history.Manager.getInstance()._setState(obips.history.getHash(),a)};obips.history.getQueryStringParameter=function(e,b){b=b||window.location.href;var a=b.indexOf("?");var g=a>=0?b.substr(a+1):b;a=g.lastIndexOf("#");g=a>=0?g.substr(0,a):g;var f=g.split("&");for(var c=0;c<f.length;c++){var d=f[c].split("=");if(d.length>=2){if(d[0].toLowerCase()===e.toLowerCase()){return saw.decodeURIComponent(d[1])}}}return null};obips.history.JsonHashGenerator=function(a){return saw.json.toString(a,true)};obips.history.UniqueNumberHashGenerator=function(){return((new Date()).getTime()).toString(16)};obips.history.EventType=function(){};obips.history.EventType.STATE_CHANGED="stateChanged";obips.history.StateChangeEventContext=function(a,b){this.hash=a;this.state=b};obips.history.Manager=function(a){if(obips.history.Manager._instance){return obips.history.Manager._instance}obips.history.Manager._instance=this;obips.history.Manager.baseConstructor.call(this);this.config={};this.currentHash=obips.history.getHash();if(saw.userAgent.is_ie7){this.iframe=document.getElementById("obips_history_iframe");if(!this.iframe){this.iframeUrl=a||saw.getEmptyHtm();var b=this.iframeUrl+"?"+this.currentHash;document.write('<iframe style="border:0;width:1px;height:1px;position:absolute;visibility:hidden;bottom:0;right:0;" name="obips_history_iframe" id="obips_history_iframe" src="'+b+'"></iframe>');this.iframe=document.getElementById("obips_history_iframe");saw.addEventListener(this.iframe,"load",this._iFrameLoaded,this,true)}this.changingHash=true}this.firstTimeLoad=true};saw.extend(obips.history.Manager,obips.Observable);obips.history.Manager.getInstance=function(){return new obips.history.Manager()};obips.history.setHash=function(a){if(!a){a=""}window.location.hash=saw.encodeURIComponent(a)};obips.history.Manager.prototype.initialize=function(b,c){this.config=c||new obips.history.Config();this.hashGenerator=this.config.hashGenerator||(this.config.stateStorage==obips.history.Config.StateStorage.LOCATION_BAR?obips.history.JsonHashGenerator:obips.history.UniqueNumberHashGenerator);if(saw.storage.HistoryStorage.getValue("pageLoaded")){this.firstTimeLoad=false}else{this.firstTimeLoad=true;saw.storage.HistoryStorage.setValue("pageLoaded",true);if(b){this._setState(null,b)}}var a=this;setInterval(function(){a._checkHashChange()},100)};obips.history.Manager.prototype._checkHashChange=function(){var a=obips.history.getHash();if(a!==this.currentHash){if(this.changingHash){this.changingHash=false}else{if(saw.userAgent.is_ie7){if(this._getIframeHash()!=a){this.changingHash=true;this._setIframeHash(a);this.changingHash=false;this._handleStateChange()}}else{this._handleStateChange()}}this.currentHash=a}};obips.history.Manager.prototype._handleStateChange=function(){var c=obips.history.getHash();var a=this._getTitleFromHash(c);if(a){document.title=a}var d=this._getStateFromHash(c);var b=new obips.history.StateChangeEventContext(c,d);this.inHistoryStateChangeHandler=true;this.notify(new obips.Observable.Event(obips.history.EventType.STATE_CHANGED,b));this.inHistoryStateChangeHandler=false};obips.history.Manager.prototype._getStateFromHash=function(a){if(this.config.stateStorage!=obips.history.Config.StateStorage.LOCATION_BAR){var b=saw.storage.HistoryStorage.getValue(a||"initState");return b&&b.state}else{if(!a){return null}return this.config.hashParser?this.config.hashParser(a):saw.json.parse(a)}};obips.history.Manager.prototype._getTitleFromHash=function(a){var b=saw.storage.HistoryStorage.getValue(a||"initState");return b&&b.title};obips.history.Manager.prototype._setState=function(b,d,a){var c=this.config.stateStorage==obips.history.Config.StateStorage.LOCATION_BAR?{title:a||document.title}:{state:d,title:a||document.title};saw.storage.HistoryStorage.setValue(b||"initState",c)};obips.history.Manager.prototype.addStateChangeListener=function(d){var a=new obips.Callback(null,function(e){d.exec(e.context.hash,e.context.state)});this.addEventListener(new obips.Observable.EventListener(obips.history.EventType.STATE_CHANGED,a));if(!this.firstTimeLoad||(this.config.stateStorage==obips.history.Config.StateStorage.LOCATION_BAR&&obips.history.getHash())){var b=obips.history.getHash();var c=this._getStateFromHash(b);d.exec(b,c);return true}return false};obips.history.Manager.prototype.addToHistory=function(c,b,a){if(this.inHistoryStateChangeHandler){return}this.changingHash=true;if(!b){b=this.hashGenerator(c)}obips.history.setHash(b);this._setState(b,c,a);if(a){document.title=a}if(saw.userAgent.is_ie7){this._setIframeHash(b)}};obips.history.Manager.prototype._setIframeHash=function(a){this.iframe.src=this.iframeUrl+"?"+a};obips.history.Manager.prototype._iFrameLoaded=function(){if(this.changingHash){this.changingHash=false;this.iframe.contentWindow.document.title=document.title;return}obips.history.setHash(this._getIframeHash());this._handleStateChange()};obips.history.Manager.prototype._getIframeHash=function(){var a=String(this.iframe.contentWindow.location.search);if(a.length==1&&a.charAt(0)=="?"){a=""}else{if(a.length>=2&&a.charAt(0)=="?"){a=a.substring(1)}}return a};if(saw.userAgent.is_ie){obips.history._oldTitle=document.title;document.onpropertychange=function(){var a=obips.history._oldTitle;var b=document.title;if(b){if(b.indexOf("#")==0||b.indexOf(a+"#")!=-1){if(document.title!=a){document.title=a}}else{if(b.indexOf("#")!=-1){b=b.substring(0,b.indexOf("#"))}if(a!=b&&b){a=b}}}}}};